/*
 * Note: this file originally auto-generated by mib2c
 * using mib2c.scalar.conf
 */
#include <net-snmp/net-snmp-config.h>
#include <net-snmp/net-snmp-includes.h>
#include <net-snmp/agent/net-snmp-agent-includes.h>
#include "kgmdedectormodulestatus.h"
#include "utils.h"
#include "defs_cpu.h"
#include "myNotifications.h"
int dedectorModule;
int otherModules;


void get_module_count(message_t* msg_ptr, int module_type){
    msg_ptr->cmd_buffer[0] = ASIST_CMD_GET_MODULE_COUNT;
    msg_ptr->cmd_buffer[1] = module_type;
    msg_ptr->cmd_size      = 2;
    send_read_message(msg_ptr);
}

void* get_dedectorModule(){
    message_t* msg_ptr = &snmp_message_buf;
    memset(msg_ptr, 0, sizeof(message_t));

    msg_ptr->cmd_buffer[0] = ASIST_CMD_GET_MODULE_COMM_FAIL_STATES;
    msg_ptr->cmd_buffer[1] = 3; // mtDetectorCard
    msg_ptr->cmd_size      = 2;
    send_read_message(msg_ptr);

    if(msg_ptr->resp_buffer[3] == ASIST_CMD_GET_MODULE_COMM_FAIL_STATES){
        uint16_t* insert_ptr = (uint16_t*)&msg_ptr->resp_buffer[5];
        uint16_t* fail_ptr   = (uint16_t*)&msg_ptr->resp_buffer[7];


        dedectorModule = *insert_ptr & (*fail_ptr);
       // log_traceI("%d", *insert_ptr);
    }

        //dedectorModule = 77;

    return &dedectorModule;
}

void* get_otherModules(){
    int i = 0;
    int curr_module_cnt = 0;
    message_t* msg_ptr = &snmp_message_buf;
    memset(msg_ptr, 0, sizeof(message_t));

    get_module_count(msg_ptr, 1);

    if(msg_ptr->resp_buffer[3] == ASIST_CMD_GET_MODULE_COUNT){
        uint8_t* module_count_ptr = &msg_ptr->resp_buffer[5];

        for(i=0; i<*module_count_ptr; ++i)
            SET_BIT(dedectorModule, i)
        curr_module_cnt = i;
    }

    get_module_count(msg_ptr, 4);

    if(msg_ptr->resp_buffer[3] == ASIST_CMD_GET_MODULE_COUNT){
        uint8_t* module_count_ptr = &msg_ptr->resp_buffer[5];

        for(i=curr_module_cnt; i<*module_count_ptr+curr_module_cnt; ++i)
            SET_BIT(dedectorModule, i)
        curr_module_cnt = i;
    }

    get_module_count(msg_ptr, 5);

    if(msg_ptr->resp_buffer[3] == ASIST_CMD_GET_MODULE_COUNT){
        uint8_t* module_count_ptr = &msg_ptr->resp_buffer[5];

        for(i=curr_module_cnt; i<*module_count_ptr+curr_module_cnt; ++i)
            SET_BIT(dedectorModule, i)
        curr_module_cnt = i;
    }

    get_module_count(msg_ptr, 6);

    if(msg_ptr->resp_buffer[3] == ASIST_CMD_GET_MODULE_COUNT){
        uint8_t* module_count_ptr = &msg_ptr->resp_buffer[5];

        for(i=curr_module_cnt; i<*module_count_ptr+curr_module_cnt; ++i)
            SET_BIT(dedectorModule, i)
        curr_module_cnt = i;
    }

    get_module_count(msg_ptr, 7);

    if(msg_ptr->resp_buffer[3] == ASIST_CMD_GET_MODULE_COUNT){
        uint8_t* module_count_ptr = &msg_ptr->resp_buffer[5];

        for(i=curr_module_cnt; i<*module_count_ptr+curr_module_cnt; ++i)
            SET_BIT(dedectorModule, i)
        curr_module_cnt = i;
    }

    get_module_count(msg_ptr, 8);

    if(msg_ptr->resp_buffer[3] == ASIST_CMD_GET_MODULE_COUNT){
        uint8_t* module_count_ptr = &msg_ptr->resp_buffer[5];

        for(i=curr_module_cnt; i<*module_count_ptr+curr_module_cnt; ++i)
            SET_BIT(dedectorModule, i)
        curr_module_cnt = i;
    }
    //dedectorModule = 77;

    return &dedectorModule;
}
/** Initializes the kgmDedectorModuleStatus module */
void
init_kgmDedectorModuleStatus(void)
{
    const oid kgmDedectorModuleStatus_oid[] = { 1,3,6,1,4,1,59873,4,2,1,5,1 };
    const oid otherModulesStatus_oid[] = { 1,3,6,1,4,1,59873,4,2,1,5,2 };

  DEBUGMSGTL(("kgmDedectorModuleStatus", "Initializing\n"));

    netsnmp_register_scalar(
        netsnmp_create_handler_registration("kgmDedectorModuleStatus", handle_kgmDedectorModuleStatus,
                               kgmDedectorModuleStatus_oid, OID_LENGTH(kgmDedectorModuleStatus_oid),
                               HANDLER_CAN_RONLY
        ));

    netsnmp_register_scalar(
        netsnmp_create_handler_registration("otherModulesStatus", handle_otherModulesStatus,
                                otherModulesStatus_oid, OID_LENGTH(otherModulesStatus_oid),
                                HANDLER_CAN_RONLY
        ));    
}

int
handle_kgmDedectorModuleStatus(netsnmp_mib_handler *handler,
                          netsnmp_handler_registration *reginfo,
                          netsnmp_agent_request_info   *reqinfo,
                          netsnmp_request_info         *requests)
{
    /* We are never called for a GETNEXT if it's registered as a
       "instance", as it's "magically" handled for us.  */

    /* a instance handler also only hands us one request at a time, so
       we don't need to loop over a list of requests; we'll only get one. */
    
    switch(reqinfo->mode) {

        case MODE_GET:
            snmp_set_var_typed_value(requests->requestvb, ASN_INTEGER, get_dedectorModule(),
            sizeof(dedectorModule));
                                     /* XXX: a pointer to the scalar's data  12,
                                      XXX: the length of the data in bytes 1); semih*/
            break;


        default:
            /* we should never get here, so this is a really bad error */
            snmp_log(LOG_ERR, "unknown mode (%d) in handle_kgmDedectorModuleStatus\n", reqinfo->mode );
            return SNMP_ERR_GENERR;
    }

    return SNMP_ERR_NOERROR;
}

int
handle_otherModulesStatus(netsnmp_mib_handler *handler,
                          netsnmp_handler_registration *reginfo,
                          netsnmp_agent_request_info   *reqinfo,
                          netsnmp_request_info         *requests)
{
    /* We are never called for a GETNEXT if it's registered as a
       "instance", as it's "magically" handled for us.  */

    /* a instance handler also only hands us one request at a time, so
       we don't need to loop over a list of requests; we'll only get one. */
    
    switch(reqinfo->mode) {

        case MODE_GET:
            snmp_set_var_typed_value(requests->requestvb, ASN_INTEGER,
                                     get_otherModules(),
                                     sizeof(otherModules));
            break;


        default:
            /* we should never get here, so this is a really bad error */
            snmp_log(LOG_ERR, "unknown mode (%d) in handle_otherModulesStatus\n", reqinfo->mode );
            return SNMP_ERR_GENERR;
    }

    return SNMP_ERR_NOERROR;
}

int currDedectorModule = DEDECTOR_MODULE_DUMMY_VAL;
int currOtherModules   = DEDECTOR_MODULE_DUMMY_VAL;

void check_dedectorModule_traps(){
    get_dedectorModule();

    if(currDedectorModule != dedectorModule){
        if(currDedectorModule != DEDECTOR_MODULE_DUMMY_VAL)
            send_dedectorModuleTrap_trap(dedectorModule);
        currDedectorModule = dedectorModule;
    }

    get_otherModules();

    if(currOtherModules != otherModules){
        if(currOtherModules != DEDECTOR_MODULE_DUMMY_VAL)
            send_otherModuleTrap_trap(otherModules);
        currOtherModules = otherModules;
    }
}
